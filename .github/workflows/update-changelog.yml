name: Update changelog

on:
  release:
    types: [published]

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1

      - name: Update CHANGELOG.md
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          # Transform ## headers to ### in the release body
          TRANSFORMED_BODY=$(echo "$RELEASE_BODY" | sed 's/^## /### /g')

          # Create the new changelog entry, preserving the "# Changelog" header
          {
            head -n 1 CHANGELOG.md
            echo ""
            echo "## $RELEASE_TAG"
            echo ""
            echo "$TRANSFORMED_BODY"
            echo ""
            tail -n +3 CHANGELOG.md
          } > CHANGELOG.md.tmp

          mv CHANGELOG.md.tmp CHANGELOG.md

      - name: Create PR
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          commit-message: "CHANGELOG.md: update changelog for ${{ github.event.release.tag_name }}"
          title: "Update CHANGELOG for ${{ github.event.release.tag_name }}"
          add-paths: CHANGELOG.md
          body: |
            ### Description

            Automated changelog update for release ${{ github.event.release.tag_name }}.

            This PR was automatically generated by the `update-changelog` workflow.
          branch: github-actions-bot/changelog-${{ github.event.release.tag_name }}
          delete-branch: true
          base: master
